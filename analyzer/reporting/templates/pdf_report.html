<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm Report - {{ date_str }} - {{ product }} - {{ environment_upper }}</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            margin: 0;
            padding: 0;
            background-color: white;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
            background-color: white;
        }

        h1 {
            color: #333;
            font-size: 16pt;
            margin: 0 0 15pt 0;
            border-bottom: 2pt solid #d73527;
            padding-bottom: 5pt;
            page-break-after: avoid;
        }

        h2 {
            color: #444;
            font-size: 14pt;
            margin: 15pt 0 8pt 0;
            page-break-after: avoid;
            page-break-before: auto;
        }

        .summary {
            background-color: #f8f8f8;
            padding: 10pt;
            margin: 8pt 0 12pt 0;
            border-left: 3pt solid #007acc;
            page-break-inside: avoid;
            page-break-after: avoid;
        }

        .statistics-box {
            display: table;
            width: 100%;
            margin: 10pt 0 15pt 0;
            border-collapse: separate;
            border-spacing: 8pt;
            page-break-inside: avoid;
        }

        .stat-row {
            display: table-row;
        }

        .stat-card {
            display: table-cell;
            width: 33.33%;
            background-color: #ffffff;
            border: 1pt solid #e0e0e0;
            padding: 10pt;
            text-align: center;
            vertical-align: middle;
        }

        .stat-card.total {
            border-color: #4a90e2;
            border-width: 1.5pt;
        }

        .stat-card.ignored {
            border-color: #ffa500;
            border-width: 1.5pt;
        }

        .stat-card.analyzed {
            border-color: #28a745;
            border-width: 1.5pt;
        }

        .stat-label {
            font-size: 8pt;
            color: #666;
            margin-bottom: 4pt;
            text-transform: uppercase;
            font-weight: bold;
        }

        .stat-value {
            font-size: 20pt;
            font-weight: bold;
            margin: 6pt 0;
        }

        .stat-card.total .stat-value {
            color: #4a90e2;
        }

        .stat-card.ignored .stat-value {
            color: #ffa500;
        }

        .stat-card.analyzed .stat-value {
            color: #28a745;
        }

        .stat-description {
            font-size: 7pt;
            color: #888;
            margin-top: 4pt;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15pt 0;
            font-size: 9pt;
            page-break-inside: auto;
        }

        th,
        td {
            text-align: left;
            padding: 6pt 4pt;
            border: 0.5pt solid #ddd;
            vertical-align: top;
            word-wrap: break-word;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 9pt;
        }

        thead {
            display: table-header-group;
        }

        tbody {
            display: table-row-group;
        }

        tr {
            page-break-inside: avoid;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Specific column widths for alarm table */
        th:nth-child(1),
        td:nth-child(1) {
            width: 40%;
        }

        /* Alarm Name */
        th:nth-child(2),
        td:nth-child(2) {
            width: 8%;
            text-align: center;
        }

        /* Count */
        th:nth-child(3),
        td:nth-child(3) {
            width: 30%;
        }

        /* Recent Occurrences */
        th:nth-child(4),
        td:nth-child(4) {
            width: 22%;
        }

        /* Hourly Distribution */

        .count-cell {
            text-align: center;
            font-size: 12pt;
            font-weight: bold;
            color: #d73527;
        }

        .alarm-name {
            font-weight: bold;
            color: #333;
            word-break: break-word;
        }

        .occurrences {
            font-family: 'Courier New', monospace;
            font-size: 8pt;
            line-height: 1.2;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20pt;
        }

        /* Ensure long text breaks properly */
        td {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        /* Hourly distribution styling */
        .hourly-dist {
            font-size: 8pt;
            line-height: 1.1;
        }

        /* Grouping for better page flow */
        .summary+h2 {
            page-break-before: avoid;
            margin-top: 8pt;
        }

        h2+table {
            page-break-before: avoid;
            margin-top: 8pt;
        }

        /* Prevent orphaned headers */
        h2:has(+ table) {
            break-after: avoid-page;
        }

        /* Print-specific rules */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
            }

            .container {
                page-break-inside: avoid;
            }

            /* Ensure continuous flow from summary to table */
            .summary,
            h2,
            table {
                orphans: 2;
                widows: 2;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸš¨ Alarm Report - {{ date_str }} - {{ product }} - {{ environment_upper }}</h1>

        <div class="summary">
            <strong>Analysis Summary:</strong> This report analyzes Slack alarm messages for the specified date range,
            filtering and categorizing them for review.
        </div>

        <div class="statistics-box">
            <div class="stat-row">
                <div class="stat-card total">
                    <div class="stat-label">Total Alarms Found</div>
                    <div class="stat-value">{{ total_alarms }}</div>
                    <div class="stat-description">All alarm messages parsed</div>
                </div>
                <div class="stat-card ignored">
                    <div class="stat-label">Alarms Ignored</div>
                    <div class="stat-value">{{ ignored_count }}</div>
                    <div class="stat-description">Filtered by ignore rules</div>
                </div>
                <div class="stat-card analyzed">
                    <div class="stat-label">Alarms Analyzed</div>
                    <div class="stat-value">{{ analyzed_alarms }}</div>
                    <div class="stat-description">Total - Ignored = {{ analyzed_alarms }}</div>
                </div>
            </div>
        </div>

        {% if analyzed_alarms > 0 %}
        <h2>Alarm Statistics Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Alarm Name</th>
                    <th>Count</th>
                    <th>Recent Occurrences</th>
                    <th>Hourly Distribution</th>
                </tr>
            </thead>
            <tbody>
                {% for alarm_name, alarm_entries in alarm_stats_sorted %}
                <tr>
                    <td class="alarm-name">{{ alarm_name }}</td>
                    <td class="count-cell">{{ alarm_entries|length }}</td>
                    <td class="occurrences">
                        {% for alarm in alarm_entries %}
                        #{{ alarm.id }} ({{ alarm.timestamp.strftime('%d-%m %H:%M') }})
                        {%- if not loop.last %}<br>{% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        <div class="hourly-dist">
                            {% for hour_info in alarm_entries | hourly_distribution %}
                            <div>{{ hour_info }}</div>
                            {% endfor %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">No alarms to display.</p>
        {% endif %}

        {% if ignored_stats_sorted and ignored_stats_sorted|length > 0 %}
        <h2>Ignored Alarms ({{ ignored_count }} total)</h2>
        <table>
            <thead>
                <tr>
                    <th style='width: 45%;'>Alarm Name</th>
                    <th style='width: 10%; text-align: center;'>Count</th>
                    <th style='width: 45%;'>Recent Occurrences</th>
                </tr>
            </thead>
            <tbody>
                {% for alarm_name, alarm_data in ignored_stats_sorted %}
                <tr>
                    <td>
                        <div class="alarm-name">{{ alarm_name }}</div>
                        <div
                            style="font-size: 7pt; color: #666; margin-top: 3pt; font-style: italic; line-height: 1.2;">
                            {{ alarm_data.reason }}
                        </div>
                        {% if alarm_data.validity %}
                        <div style="font-size: 6pt; color: #888; margin-top: 2pt; line-height: 1.2;">
                            <strong>Validity:</strong>
                            {% for line in alarm_data.validity | format_time_constraint %}
                            <div style="margin-left: 8pt;">{{ line }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if alarm_data.exclusions %}
                        <div style="font-size: 6pt; color: #888; margin-top: 2pt; line-height: 1.2;">
                            <strong>Exclusions:</strong>
                            {% for line in alarm_data.exclusions | format_time_constraint %}
                            <div style="margin-left: 8pt;">{{ line }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </td>
                    <td class="count-cell">{{ alarm_data.count }}</td>
                    <td class="occurrences">
                        {% for occurrence in alarm_data.occurrences %}
                        #{{ occurrence.id }} ({{ occurrence.timestamp.strftime('%d-%m %H:%M') if occurrence.timestamp
                        else 'N/A' }})
                        {%- if not loop.last %}<br>{% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</body>

</html>